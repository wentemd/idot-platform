<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDOT Bid Intelligence Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 1.5rem 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header h1 {
            font-size: 1.8rem;
            margin-bottom: 0.25rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1rem;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
            align-items: center;
        }

        .header-btn {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .header-btn.primary {
            background: #28a745;
            border-color: #28a745;
        }

        .header-btn.primary:hover {
            background: #218838;
        }

        .user-menu {
            position: relative;
            display: inline-block;
        }

        .user-menu-btn {
            display: flex;
            align-items: center;
            gap: 0.5rem;
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            cursor: pointer;
        }

        .user-menu-dropdown {
            display: none;
            position: absolute;
            right: 0;
            top: 100%;
            background: white;
            border-radius: 4px;
            box-shadow: 0 4px 12px rgba(0,0,0,0.15);
            min-width: 200px;
            z-index: 100;
        }

        .user-menu-dropdown.show {
            display: block;
        }

        .user-menu-dropdown a, .user-menu-dropdown button {
            display: block;
            width: 100%;
            padding: 0.75rem 1rem;
            text-align: left;
            color: #333;
            text-decoration: none;
            border: none;
            background: none;
            cursor: pointer;
            font-size: 0.9rem;
        }

        .user-menu-dropdown a:hover, .user-menu-dropdown button:hover {
            background: #f5f5f5;
        }

        .user-menu-dropdown .tier-badge {
            padding: 0.75rem 1rem;
            border-bottom: 1px solid #eee;
            font-size: 0.85rem;
        }

        .tier-badge.free {
            color: #666;
        }

        .tier-badge.pro {
            color: #28a745;
            font-weight: 600;
        }

        .searches-remaining {
            background: rgba(255,255,255,0.15);
            padding: 0.3rem 0.6rem;
            border-radius: 4px;
            font-size: 0.8rem;
            margin-right: 0.5rem;
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(160px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-card .value {
            font-size: 1.6rem;
            font-weight: bold;
            color: #1e3a5f;
        }

        .stat-card .label {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .search-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 0.6rem 1.2rem;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .tab-button:hover {
            border-color: #1e3a5f;
        }

        .tab-button.active {
            background: #1e3a5f;
            color: white;
            border-color: #1e3a5f;
        }

        .tab-button.pro-feature {
            position: relative;
        }

        .tab-button.pro-feature::after {
            content: 'PRO';
            position: absolute;
            top: -8px;
            right: -8px;
            background: #ffc107;
            color: #333;
            font-size: 0.65rem;
            padding: 0.1rem 0.3rem;
            border-radius: 3px;
            font-weight: bold;
        }

        .search-box {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .search-box input, .search-box select {
            padding: 0.7rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-box input {
            flex: 1;
            min-width: 200px;
        }

        .search-box input:focus, .search-box select:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .search-box button {
            padding: 0.7rem 1.5rem;
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-box button:hover {
            background: #2d5a87;
        }

        .filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters label {
            font-size: 0.9rem;
            color: #666;
        }

        .filters input, .filters select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .results {
            margin-top: 1.5rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .results-header h3 {
            color: #1e3a5f;
        }

        .results-count {
            color: #666;
            font-size: 0.9rem;
        }

        .back-button {
            padding: 0.4rem 0.8rem;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #1e3a5f;
        }

        .summary-card h4 {
            color: #1e3a5f;
            margin-bottom: 0.75rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(140px, 1fr));
            gap: 1rem;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat .value {
            font-size: 1.3rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .summary-stat .label {
            font-size: 0.8rem;
            color: #666;
        }

        .yearly-trends {
            margin: 1rem 0;
        }

        .trend-bar {
            display: flex;
            align-items: center;
            margin: 0.4rem 0;
            font-size: 0.9rem;
        }

        .trend-bar .year {
            width: 50px;
            font-weight: 600;
            color: #1e3a5f;
        }

        .trend-bar .bar-container {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 0 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .trend-bar .bar {
            height: 100%;
            background: linear-gradient(90deg, #1e3a5f 0%, #2d5a87 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 50px;
        }

        .trend-bar .count {
            width: 100px;
            text-align: right;
            color: #666;
            font-size: 0.85rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .data-table th {
            background: #1e3a5f;
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 0.6rem 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table .number {
            text-align: right;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .data-table .winner {
            background: #d4edda;
        }

        .data-table .winner:hover {
            background: #c3e6cb;
        }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-winner {
            background: #28a745;
            color: white;
        }

        .badge-rank {
            background: #6c757d;
            color: white;
        }

        .badge-pro {
            background: #ffc107;
            color: #333;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .comparison-table th {
            background: #1e3a5f;
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .comparison-table th.item-col {
            text-align: left;
            min-width: 200px;
        }

        .comparison-table td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }

        .comparison-table td.item-col {
            text-align: left;
            background: #f8f9fa;
        }

        .comparison-table .winner-col {
            background: #d4edda;
        }

        .comparison-table .low-price {
            color: #28a745;
            font-weight: bold;
        }

        .comparison-table .high-price {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .contractor-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .contractor-card h4 {
            color: #1e3a5f;
            margin-bottom: 0.5rem;
        }

        .contractor-stats {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .contractor-stat {
            text-align: center;
        }

        .contractor-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .contractor-stat .label {
            font-size: 0.8rem;
            color: #666;
        }

        .footer {
            text-align: center;
            padding: 2rem 1rem;
            color: #7f8c8d;
            margin-top: 2rem;
        }

        .hidden {
            display: none !important;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 450px;
            width: 90%;
            max-height: 90vh;
            overflow-y: auto;
        }

        .modal-content h2 {
            color: #1e3a5f;
            margin-bottom: 1.5rem;
            text-align: center;
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #333;
        }

        .form-group {
            margin-bottom: 1rem;
        }

        .form-group label {
            display: block;
            margin-bottom: 0.5rem;
            font-weight: 500;
            color: #333;
        }

        .form-group input {
            width: 100%;
            padding: 0.75rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 1rem;
        }

        .form-group input:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .btn {
            width: 100%;
            padding: 0.75rem;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .btn-primary {
            background: #1e3a5f;
            color: white;
        }

        .btn-primary:hover {
            background: #2d5a87;
        }

        .btn-google {
            background: white;
            border: 1px solid #ddd;
            color: #333;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 0.5rem;
            margin-top: 1rem;
        }

        .btn-google:hover {
            background: #f5f5f5;
        }

        .btn-upgrade {
            background: linear-gradient(135deg, #28a745 0%, #20c997 100%);
            color: white;
        }

        .btn-upgrade:hover {
            background: linear-gradient(135deg, #218838 0%, #1aa179 100%);
        }

        .divider {
            text-align: center;
            margin: 1rem 0;
            color: #999;
            position: relative;
        }

        .divider::before, .divider::after {
            content: '';
            position: absolute;
            top: 50%;
            width: 40%;
            height: 1px;
            background: #ddd;
        }

        .divider::before { left: 0; }
        .divider::after { right: 0; }

        .form-footer {
            text-align: center;
            margin-top: 1rem;
            color: #666;
        }

        .form-footer a {
            color: #1e3a5f;
            cursor: pointer;
        }

        .upgrade-prompt {
            background: linear-gradient(135deg, #fff3cd 0%, #ffeeba 100%);
            border: 1px solid #ffc107;
            border-radius: 8px;
            padding: 1.5rem;
            margin: 1rem 0;
            text-align: center;
        }

        .upgrade-prompt h4 {
            color: #856404;
            margin-bottom: 0.5rem;
        }

        .upgrade-prompt p {
            color: #856404;
            margin-bottom: 1rem;
        }

        .pricing-cards {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 1rem;
            margin: 1rem 0;
        }

        .pricing-card {
            background: white;
            border: 2px solid #e0e0e0;
            border-radius: 8px;
            padding: 1.5rem;
            text-align: center;
        }

        .pricing-card.featured {
            border-color: #28a745;
            position: relative;
        }

        .pricing-card.featured::before {
            content: 'BEST VALUE';
            position: absolute;
            top: -12px;
            left: 50%;
            transform: translateX(-50%);
            background: #28a745;
            color: white;
            padding: 0.2rem 0.75rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: bold;
        }

        .pricing-card h3 {
            color: #1e3a5f;
            margin-bottom: 0.5rem;
        }

        .pricing-card .price {
            font-size: 2rem;
            font-weight: bold;
            color: #333;
        }

        .pricing-card .price span {
            font-size: 1rem;
            color: #666;
        }

        .pricing-card .savings {
            color: #28a745;
            font-size: 0.9rem;
            margin-bottom: 1rem;
        }

        .pricing-card ul {
            text-align: left;
            margin: 1rem 0;
            padding-left: 1.5rem;
        }

        .pricing-card li {
            margin-bottom: 0.5rem;
            color: #666;
        }

        .disclaimer {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.4rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .data-table {
                font-size: 0.8rem;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div>
                    <h1>üèóÔ∏è IDOT Bid Intelligence Platform</h1>
                    <p>Construction bid pricing data for Illinois</p>
                </div>
                <div class="header-buttons">
                    <!-- Logged out state -->
                    <div id="loggedOutButtons">
                        <button class="header-btn" onclick="showHelp()">‚ùì Help</button>
                        <button class="header-btn" onclick="showLogin()">Log In</button>
                        <button class="header-btn primary" onclick="showSignup()">Sign Up Free</button>
                    </div>
                    <!-- Logged in state -->
                    <div id="loggedInButtons" class="hidden">
                        <span id="searchesRemaining" class="searches-remaining hidden">10 searches left today</span>
                        <button class="header-btn" onclick="showHelp()">‚ùì Help</button>
                        <div class="user-menu">
                            <button class="user-menu-btn" onclick="toggleUserMenu()">
                                <span id="userName">Account</span> ‚ñº
                            </button>
                            <div id="userMenuDropdown" class="user-menu-dropdown">
                                <div id="tierBadge" class="tier-badge free">Free Plan</div>
                                <button onclick="showPricing()">‚≠ê Upgrade to Pro</button>
                                <button onclick="manageSubscription()">üí≥ Manage Subscription</button>
                                <button onclick="logout()">üö™ Log Out</button>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Dashboard -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="value">‚Äî</div>
                <div class="label">Loading...</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="payitem">Pay Item Search</button>
                <button class="tab-button" data-tab="contractor">Contractor Search</button>
                <button class="tab-button" data-tab="contract">Contract Lookup</button>
                <button class="tab-button" data-tab="browse">Browse Items</button>
                <button class="tab-button pro-feature" data-tab="estimator">üìä Estimator Tool</button>
            </div>

            <!-- Pay Item Search -->
            <div id="payitem-tab" class="tab-content">
                <div class="search-box">
                    <input type="text" id="payItemInput" placeholder="Enter item code (e.g., 40603080, 60105)" />
                    <button onclick="searchPayItem()">Search</button>
                </div>
                <div class="filters">
                    <label>District:</label>
                    <select id="payItemDistrict">
                        <option value="">All</option>
                    </select>
                    <label>County:</label>
                    <input type="text" id="payItemCounty" placeholder="Optional" style="width: 120px;" />
                    <label>Year From:</label>
                    <select id="payItemYearStart">
                        <option value="">All</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                    </select>
                    <label>To:</label>
                    <select id="payItemYearEnd">
                        <option value="">All</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                    </select>
                </div>
            </div>

            <!-- Contractor Search -->
            <div id="contractor-tab" class="tab-content hidden">
                <div class="search-box">
                    <input type="text" id="contractorInput" placeholder="Enter contractor name (e.g., K-Five, Gallagher, Alliance)" />
                    <button onclick="searchContractor()">Search</button>
                </div>
                <div class="filters">
                    <label>District:</label>
                    <select id="contractorDistrict">
                        <option value="">All</option>
                    </select>
                    <label>County:</label>
                    <input type="text" id="contractorCounty" placeholder="Optional" style="width: 120px;" />
                    <label>Year From:</label>
                    <select id="contractorYearStart">
                        <option value="">All</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                    </select>
                    <label>To:</label>
                    <select id="contractorYearEnd">
                        <option value="">All</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                    </select>
                </div>
            </div>

            <!-- Contract Lookup -->
            <div id="contract-tab" class="tab-content hidden">
                <div class="search-box">
                    <input type="text" id="contractInput" placeholder="Enter contract number (e.g., 61J77, 62T57)" />
                    <button onclick="searchContract()">Search</button>
                </div>
            </div>

            <!-- Browse Items -->
            <div id="browse-tab" class="tab-content hidden">
                <div class="search-box">
                    <input type="text" id="browseInput" placeholder="Search by item code or description" />
                    <button onclick="browseItems()">Search</button>
                </div>
            </div>

            <!-- Estimator Tool (Pro Only) -->
            <div id="estimator-tab" class="tab-content hidden">
                <div id="estimatorProPrompt" class="upgrade-prompt">
                    <h4>üîí Pro Feature</h4>
                    <p>The Estimator Tool requires a Pro subscription. Upload Excel files with pay items to get instant weighted average pricing.</p>
                    <button class="btn btn-upgrade" onclick="showPricing()" style="width: auto; padding: 0.75rem 2rem;">
                        Start 7-Day Free Trial
                    </button>
                </div>
                
                <div id="estimatorContent" class="hidden">
                    <div class="summary-card" style="margin-bottom: 1.5rem;">
                        <h4>üìä Estimator Pricing Tool</h4>
                        <p style="margin: 0.5rem 0; color: #666;">
                            Upload an Excel file with pay items and quantities to get weighted average unit prices based on <strong>winning bid</strong> historical data.
                        </p>
                        <ul style="margin: 0.5rem 0 0 1.5rem; color: #666; font-size: 0.9rem;">
                            <li>Maximum 300 items per upload</li>
                            <li>Prices are weighted averages from <strong>winning contractors only</strong></li>
                            <li>Filter by district and year range for more accurate estimates</li>
                        </ul>
                    </div>

                    <div style="margin-bottom: 1rem;">
                        <a href="/api/estimator/template" class="header-btn" style="background: #1e3a5f; color: white; text-decoration: none; display: inline-block;">
                            ‚¨áÔ∏è Download Template
                        </a>
                    </div>

                    <form id="estimatorForm" enctype="multipart/form-data">
                        <div class="search-box" style="flex-direction: column; align-items: stretch;">
                            <div style="display: flex; gap: 0.75rem; flex-wrap: wrap; align-items: center;">
                                <label style="font-weight: 600;">Excel File:</label>
                                <input type="file" id="estimatorFile" name="file" accept=".xlsx,.xls" required style="flex: 1;" />
                            </div>
                        </div>
                        
                        <div class="filters" style="margin-top: 1rem;">
                            <label>Districts (select one or more):</label>
                            <select id="estimatorDistricts" multiple style="min-width: 200px; height: 80px;">
                            </select>
                            <label>Year From:</label>
                            <select id="estimatorYearStart">
                                <option value="">All</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                                <option value="2018">2018</option>
                            </select>
                            <label>To:</label>
                            <select id="estimatorYearEnd">
                                <option value="">All</option>
                                <option value="2025">2025</option>
                                <option value="2024">2024</option>
                                <option value="2023">2023</option>
                                <option value="2022">2022</option>
                                <option value="2021">2021</option>
                                <option value="2020">2020</option>
                                <option value="2019">2019</option>
                                <option value="2018">2018</option>
                            </select>
                        </div>
                        
                        <div style="margin-top: 1rem;">
                            <button type="submit" style="padding: 0.7rem 2rem; background: #28a745; color: white; border: none; border-radius: 4px; font-size: 1rem; cursor: pointer;">
                                üöÄ Generate Prices
                            </button>
                        </div>
                    </form>
                    
                    <div id="estimatorStatus" style="margin-top: 1rem;"></div>
                </div>
            </div>

            <div id="results" class="results"></div>
        </div>
    </div>

    <div class="footer">
        <p>IDOT Bid Intelligence Platform v2.0 ‚Ä¢ Data may be incomplete or contain errors</p>
    </div>

    <!-- Login Modal -->
    <div id="loginModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeLogin()">&times;</span>
            <h2>Log In</h2>
            
            <form id="loginForm" onsubmit="handleLogin(event)">
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="loginEmail" required />
                </div>
                <div class="form-group">
                    <label>Password</label>
                    <input type="password" id="loginPassword" required />
                </div>
                <div id="loginError" class="error hidden"></div>
                <button type="submit" class="btn btn-primary">Log In</button>
            </form>
            
            <div class="form-footer">
                Don't have an account? <a onclick="showSignup(); closeLogin();">Sign up free</a>
            </div>
        </div>
    </div>

    <!-- Signup Modal -->
    <div id="signupModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeSignup()">&times;</span>
            <h2>Create Account</h2>
            
            <form id="signupForm" onsubmit="handleSignup(event)">
                <div class="form-group">
                    <label>Name (optional)</label>
                    <input type="text" id="signupName" />
                </div>
                <div class="form-group">
                    <label>Email</label>
                    <input type="email" id="signupEmail" required />
                </div>
                <div class="form-group">
                    <label>Password (min 8 characters)</label>
                    <input type="password" id="signupPassword" minlength="8" required />
                </div>
                <div id="signupError" class="error hidden"></div>
                <button type="submit" class="btn btn-primary">Create Account</button>
            </form>
            
            <div class="form-footer">
                Already have an account? <a onclick="showLogin(); closeSignup();">Log in</a>
            </div>
        </div>
    </div>

    <!-- Pricing Modal -->
    <div id="pricingModal" class="modal">
        <div class="modal-content" style="max-width: 600px;">
            <span class="close-modal" onclick="closePricing()">&times;</span>
            <h2>Upgrade to Pro</h2>
            <p style="text-align: center; color: #666; margin-bottom: 1.5rem;">
                Unlock unlimited searches and the powerful Estimator Tool
            </p>
            
            <div class="pricing-cards">
                <div class="pricing-card">
                    <h3>Monthly</h3>
                    <div class="price">$49<span>/mo</span></div>
                    <div class="savings">&nbsp;</div>
                    <button class="btn btn-primary" onclick="subscribe('monthly')">Start 7-Day Free Trial</button>
                </div>
                <div class="pricing-card featured">
                    <h3>Annual</h3>
                    <div class="price">$499<span>/yr</span></div>
                    <div class="savings">Save $89/year</div>
                    <button class="btn btn-upgrade" onclick="subscribe('yearly')">Start 7-Day Free Trial</button>
                </div>
            </div>
            
            <ul style="margin: 1.5rem 0; padding-left: 1.5rem;">
                <li><strong>Unlimited searches</strong> - no daily limits</li>
                <li><strong>Estimator Tool</strong> - upload Excel files for instant pricing</li>
                <li><strong>500 results per query</strong> - vs 50 for free</li>
                <li><strong>Priority support</strong></li>
                <li><strong>7-day free trial</strong> - cancel anytime</li>
            </ul>
            
            <p style="text-align: center; color: #666; font-size: 0.9rem;">
                Cancel anytime during your trial. No charge until trial ends.
            </p>
        </div>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content" style="max-width: 700px;">
            <span class="close-modal" onclick="closeHelp()">&times;</span>
            <h2>üìñ How to Use This Platform</h2>
            
            <h3 style="color: #2d5a87; margin-top: 1.5rem;">Pay Item Search</h3>
            <p>Search for specific bid items by their IDOT item code. View pricing history across all contractors and projects.</p>
            <ul style="margin: 0.5rem 0 1rem 1.5rem;">
                <li>Prices shown are <strong>weighted averages from winning bids</strong></li>
                <li>Filter by district, county, or year range</li>
            </ul>

            <h3 style="color: #2d5a87;">Contractor Search</h3>
            <p>Look up any contractor's bidding history, win rate, and contract performance.</p>

            <h3 style="color: #2d5a87;">Contract Lookup</h3>
            <p>View complete bid tabulation for any contract, showing all bidders' prices side-by-side.</p>

            <h3 style="color: #2d5a87;">Estimator Tool <span class="badge badge-pro">PRO</span></h3>
            <p>Upload an Excel file with pay items and quantities to get instant weighted average pricing from winning bids.</p>

            <div class="disclaimer">
                <strong>‚ö†Ô∏è Disclaimer:</strong> This data is compiled from IDOT bid tabulations and may be incomplete or contain parsing errors. Always verify critical pricing information against official IDOT sources.
            </div>
        </div>
    </div>

    <script>
        // ============================================================================
        // STATE
        // ============================================================================
        let currentUser = null;
        let navHistory = [];

        // ============================================================================
        // AUTH FUNCTIONS
        // ============================================================================
        async function checkAuth() {
            try {
                const response = await fetch('/api/auth/me');
                const data = await response.json();
                
                if (data.user) {
                    currentUser = data.user;
                    updateUIForUser();
                } else {
                    currentUser = null;
                    updateUIForGuest();
                }
            } catch (error) {
                console.error('Auth check failed:', error);
                currentUser = null;
                updateUIForGuest();
            }
        }

        function updateUIForUser() {
            document.getElementById('loggedOutButtons').classList.add('hidden');
            document.getElementById('loggedInButtons').classList.remove('hidden');
            document.getElementById('userName').textContent = currentUser.name || currentUser.email.split('@')[0];
            
            // Update tier badge
            const tierBadge = document.getElementById('tierBadge');
            if (currentUser.tier === 'pro' && currentUser.subscription_status === 'active') {
                tierBadge.textContent = '‚≠ê Pro Plan';
                tierBadge.className = 'tier-badge pro';
                document.querySelector('[onclick="showPricing()"]').classList.add('hidden');
            } else if (currentUser.subscription_status === 'trialing') {
                tierBadge.textContent = '‚≠ê Pro Trial';
                tierBadge.className = 'tier-badge pro';
            } else {
                tierBadge.textContent = 'Free Plan';
                tierBadge.className = 'tier-badge free';
            }
            
            // Show searches remaining for free users
            const searchesEl = document.getElementById('searchesRemaining');
            if (currentUser.limits && currentUser.limits.daily_searches < 1000) {
                const remaining = currentUser.limits.daily_searches - (currentUser.daily_searches || 0);
                searchesEl.textContent = `${remaining} searches left today`;
                searchesEl.classList.remove('hidden');
            } else {
                searchesEl.classList.add('hidden');
            }
            
            // Show/hide estimator based on access
            updateEstimatorAccess();
        }

        function updateUIForGuest() {
            document.getElementById('loggedOutButtons').classList.remove('hidden');
            document.getElementById('loggedInButtons').classList.add('hidden');
            document.getElementById('searchesRemaining').classList.add('hidden');
            updateEstimatorAccess();
        }

        function updateEstimatorAccess() {
            const hasAccess = currentUser && currentUser.limits && currentUser.limits.estimator_access;
            document.getElementById('estimatorProPrompt').classList.toggle('hidden', hasAccess);
            document.getElementById('estimatorContent').classList.toggle('hidden', !hasAccess);
        }

        // Modal functions
        function showLogin() { document.getElementById('loginModal').classList.add('show'); }
        function closeLogin() { document.getElementById('loginModal').classList.remove('show'); }
        function showSignup() { document.getElementById('signupModal').classList.add('show'); }
        function closeSignup() { document.getElementById('signupModal').classList.remove('show'); }
        function showPricing() { 
            if (!currentUser) {
                showSignup();
                return;
            }
            document.getElementById('pricingModal').classList.add('show'); 
        }
        function closePricing() { document.getElementById('pricingModal').classList.remove('show'); }
        function showHelp() { document.getElementById('helpModal').classList.add('show'); }
        function closeHelp() { document.getElementById('helpModal').classList.remove('show'); }

        function toggleUserMenu() {
            document.getElementById('userMenuDropdown').classList.toggle('show');
        }

        // Close dropdown when clicking outside
        document.addEventListener('click', function(e) {
            if (!e.target.closest('.user-menu')) {
                document.getElementById('userMenuDropdown').classList.remove('show');
            }
        });

        // Close modals when clicking outside
        document.querySelectorAll('.modal').forEach(modal => {
            modal.addEventListener('click', function(e) {
                if (e.target === this) {
                    this.classList.remove('show');
                }
            });
        });

        async function handleLogin(e) {
            e.preventDefault();
            const email = document.getElementById('loginEmail').value;
            const password = document.getElementById('loginPassword').value;
            const errorEl = document.getElementById('loginError');
            
            try {
                const response = await fetch('/api/auth/login', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ email, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    errorEl.textContent = data.detail || 'Login failed';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                closeLogin();
                await checkAuth();
            } catch (error) {
                errorEl.textContent = 'Network error. Please try again.';
                errorEl.classList.remove('hidden');
            }
        }

        async function handleSignup(e) {
            e.preventDefault();
            const name = document.getElementById('signupName').value;
            const email = document.getElementById('signupEmail').value;
            const password = document.getElementById('signupPassword').value;
            const errorEl = document.getElementById('signupError');
            
            try {
                const response = await fetch('/api/auth/register', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ name, email, password })
                });
                
                const data = await response.json();
                
                if (!response.ok) {
                    errorEl.textContent = data.detail || 'Signup failed';
                    errorEl.classList.remove('hidden');
                    return;
                }
                
                closeSignup();
                await checkAuth();
            } catch (error) {
                errorEl.textContent = 'Network error. Please try again.';
                errorEl.classList.remove('hidden');
            }
        }

        async function logout() {
            await fetch('/api/auth/logout', { method: 'POST' });
            currentUser = null;
            updateUIForGuest();
            document.getElementById('userMenuDropdown').classList.remove('show');
        }

        async function subscribe(plan) {
            if (!currentUser) {
                showSignup();
                closePricing();
                return;
            }
            
            try {
                const response = await fetch(`/api/stripe/create-checkout-session?plan=${plan}`, {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.checkout_url) {
                    window.location.href = data.checkout_url;
                } else {
                    alert('Error creating checkout session');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        async function manageSubscription() {
            try {
                const response = await fetch('/api/stripe/create-portal-session', {
                    method: 'POST'
                });
                const data = await response.json();
                
                if (data.portal_url) {
                    window.location.href = data.portal_url;
                } else {
                    alert(data.detail || 'No subscription found');
                }
            } catch (error) {
                alert('Error: ' + error.message);
            }
        }

        // Check for URL params (subscription success, Google login)
        function checkUrlParams() {
            const params = new URLSearchParams(window.location.search);
            if (params.get('subscription') === 'success') {
                alert('üéâ Welcome to Pro! Your subscription is now active.');
                window.history.replaceState({}, '', '/');
                checkAuth();
            }
            if (params.get('login') === 'success') {
                window.history.replaceState({}, '', '/');
                checkAuth();
            }
        }

        // ============================================================================
        // TAB SWITCHING
        // ============================================================================
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + '-tab').classList.remove('hidden');
                document.getElementById('results').innerHTML = '';
                navHistory = [];
            });
        });

        // ============================================================================
        // DATA LOADING
        // ============================================================================
        async function loadStats() {
            try {
                const response = await fetch('/api/analytics/summary');
                if (!response.ok) throw new Error('Failed to load stats');
                const data = await response.json();
                
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="value">${(data.total_bid_rows / 1000000).toFixed(2)}M</div>
                        <div class="label">Bid Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.unique_contracts?.toLocaleString() || '‚Äî'}</div>
                        <div class="label">Contracts</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.unique_contractors?.toLocaleString() || '‚Äî'}</div>
                        <div class="label">Contractors</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.unique_items?.toLocaleString() || '‚Äî'}</div>
                        <div class="label">Pay Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.unique_counties || '‚Äî'}</div>
                        <div class="label">Counties</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
            }
        }

        async function loadDistricts() {
            try {
                const response = await fetch('/api/browse/districts');
                const data = await response.json();
                
                const districtOptions = '<option value="">All</option>' + 
                    data.districts.map(d => `<option value="${d.district}">${d.district} (${d.contract_count})</option>`).join('');
                
                document.getElementById('payItemDistrict').innerHTML = districtOptions;
                document.getElementById('contractorDistrict').innerHTML = districtOptions;
                
                const estimatorOptions = data.districts.map(d => 
                    `<option value="${d.district}">${d.district} (${d.contract_count} contracts)</option>`
                ).join('');
                document.getElementById('estimatorDistricts').innerHTML = estimatorOptions;
            } catch (error) {
                console.error('Error loading districts:', error);
            }
        }

        // ============================================================================
        // UTILITIES
        // ============================================================================
        function formatCurrency(value) {
            if (value === null || value === undefined || value === '') return '‚Äî';
            return '$' + parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        function pushNav(type, params) {
            navHistory.push({ type, params });
        }

        function goBack() {
            if (navHistory.length > 1) {
                navHistory.pop();
                const prev = navHistory.pop();
                if (prev.type === 'contractor') searchContractorWithParams(prev.params);
                else if (prev.type === 'contract') searchContractDirect(prev.params.contract);
                else if (prev.type === 'payitem') searchPayItemWithParams(prev.params);
            }
        }

        function getBackButton() {
            return navHistory.length > 1 ? '<button class="back-button" onclick="goBack()">‚Üê Back</button>' : '';
        }

        async function handleSearchError(response, resultsDiv) {
            if (response.status === 429) {
                const data = await response.json();
                resultsDiv.innerHTML = `
                    <div class="upgrade-prompt">
                        <h4>Daily Search Limit Reached</h4>
                        <p>${data.detail}</p>
                        <button class="btn btn-upgrade" onclick="showPricing()" style="width: auto; padding: 0.75rem 2rem;">
                            Upgrade to Pro - Unlimited Searches
                        </button>
                    </div>
                `;
                return true;
            }
            return false;
        }

        // ============================================================================
        // SEARCH FUNCTIONS
        // ============================================================================
        async function searchPayItem() {
            const params = {
                itemCode: document.getElementById('payItemInput').value.trim(),
                county: document.getElementById('payItemCounty').value.trim(),
                district: document.getElementById('payItemDistrict').value,
                yearStart: document.getElementById('payItemYearStart').value,
                yearEnd: document.getElementById('payItemYearEnd').value
            };
            searchPayItemWithParams(params);
        }

        async function searchPayItemWithParams(params) {
            if (!params.itemCode) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Searching</div>';
            pushNav('payitem', params);
            
            try {
                let url = `/api/search/pay-item/${encodeURIComponent(params.itemCode)}?limit=500`;
                if (params.county) url += `&county=${encodeURIComponent(params.county)}`;
                if (params.district) url += `&district=${encodeURIComponent(params.district)}`;
                if (params.yearStart) url += `&year_start=${params.yearStart}`;
                if (params.yearEnd) url += `&year_end=${params.yearEnd}`;
                
                const response = await fetch(url);
                
                if (await handleSearchError(response, resultsDiv)) {
                    await checkAuth();
                    return;
                }
                
                const data = await response.json();
                
                if (data.result_count === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No results found for this item code.</div>';
                    return;
                }
                
                const validBids = data.bids.filter(b => b.unit_price > 0 && b.quantity > 0);
                const totalExtension = validBids.reduce((sum, b) => sum + (b.extension || 0), 0);
                const totalQuantity = validBids.reduce((sum, b) => sum + (b.quantity || 0), 0);
                const weightedAvgPrice = totalQuantity > 0 ? totalExtension / totalQuantity : 0;
                const prices = validBids.map(b => b.unit_price);
                const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
                const maxPrice = prices.length > 0 ? Math.max(...prices) : 0;
                const descriptions = [...new Set(data.bids.map(b => b.item_description))];
                const units = [...new Set(data.bids.map(b => b.unit))];
                
                let trendsHtml = '';
                if (data.yearly_trends && data.yearly_trends.length > 0) {
                    const maxCount = Math.max(...data.yearly_trends.map(t => t.bid_count));
                    trendsHtml = `
                        <div class="yearly-trends">
                            <h4 style="margin-bottom: 0.75rem; color: #1e3a5f;">Yearly Pricing Trends (Weighted Avg - Winning Bids)</h4>
                            ${data.yearly_trends.map(t => `
                                <div class="trend-bar">
                                    <span class="year">${t.year}</span>
                                    <div class="bar-container">
                                        <div class="bar" style="width: ${(t.bid_count / maxCount * 100)}%">
                                            ${formatCurrency(t.weighted_avg_price)}
                                        </div>
                                    </div>
                                    <span class="count">${t.bid_count} bids</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = `
                    <div class="results-header">
                        <h3>Results for "${params.itemCode}"</h3>
                        <span class="results-count">${data.result_count.toLocaleString()} records</span>
                        ${getBackButton()}
                    </div>
                    
                    <div class="summary-card">
                        <h4>${descriptions[0] || params.itemCode}</h4>
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="value">${formatCurrency(weightedAvgPrice)}</div>
                                <div class="label">Weighted Avg (Winners)</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${formatCurrency(minPrice)}</div>
                                <div class="label">Min Price</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${formatCurrency(maxPrice)}</div>
                                <div class="label">Max Price</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${units[0] || '‚Äî'}</div>
                                <div class="label">Unit</div>
                            </div>
                        </div>
                    </div>
                    
                    ${trendsHtml}
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Contract</th>
                                    <th>Date</th>
                                    <th>County</th>
                                    <th>Bidder</th>
                                    <th>Rank</th>
                                    <th class="number">Qty</th>
                                    <th class="number">Unit Price</th>
                                    <th class="number">Extension</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.bids.slice(0, 200).map(bid => `
                                    <tr class="${bid.is_winner === 'Y' ? 'winner' : ''}">
                                        <td><a href="#" onclick="searchContractDirect('${bid.contract_number}'); return false;">${bid.contract_number}</a></td>
                                        <td>${bid.letting_date}</td>
                                        <td>${bid.county || '‚Äî'}</td>
                                        <td>${bid.bidder_name}${bid.is_winner === 'Y' ? ' <span class="badge badge-winner">WIN</span>' : ''}</td>
                                        <td><span class="badge badge-rank">#${bid.bidder_rank}</span></td>
                                        <td class="number">${bid.quantity?.toLocaleString() || '‚Äî'}</td>
                                        <td class="number">${formatCurrency(bid.unit_price)}</td>
                                        <td class="number">${formatCurrency(bid.extension)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                await checkAuth();
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function searchContractor() {
            const params = {
                name: document.getElementById('contractorInput').value.trim(),
                county: document.getElementById('contractorCounty').value.trim(),
                district: document.getElementById('contractorDistrict').value,
                yearStart: document.getElementById('contractorYearStart').value,
                yearEnd: document.getElementById('contractorYearEnd').value
            };
            searchContractorWithParams(params);
        }

        async function searchContractorWithParams(params) {
            if (!params.name) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Searching</div>';
            pushNav('contractor', params);
            
            try {
                let url = `/api/search/contractor/${encodeURIComponent(params.name)}`;
                const queryParams = [];
                if (params.county) queryParams.push(`county=${encodeURIComponent(params.county)}`);
                if (params.district) queryParams.push(`district=${encodeURIComponent(params.district)}`);
                if (params.yearStart) queryParams.push(`year_start=${params.yearStart}`);
                if (params.yearEnd) queryParams.push(`year_end=${params.yearEnd}`);
                if (queryParams.length > 0) url += '?' + queryParams.join('&');
                
                const response = await fetch(url);
                
                if (await handleSearchError(response, resultsDiv)) {
                    await checkAuth();
                    return;
                }
                
                const data = await response.json();
                
                if (data.contract_count === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No results found for this contractor.</div>';
                    return;
                }
                
                let statsHtml = '';
                if (data.contractor_stats && data.contractor_stats.length > 0) {
                    statsHtml = data.contractor_stats.map(stat => `
                        <div class="contractor-card">
                            <h4>${stat.bidder_name}</h4>
                            <div class="contractor-stats">
                                <div class="contractor-stat">
                                    <div class="value">${stat.contracts_bid}</div>
                                    <div class="label">Contracts Bid</div>
                                </div>
                                <div class="contractor-stat">
                                    <div class="value">${stat.contracts_won || 0}</div>
                                    <div class="label">Contracts Won</div>
                                </div>
                                <div class="contractor-stat">
                                    <div class="value">${stat.win_rate.toFixed(1)}%</div>
                                    <div class="label">Win Rate</div>
                                </div>
                                <div class="contractor-stat">
                                    <div class="value">${formatCurrency(stat.total_won_value)}</div>
                                    <div class="label">Total Won Value</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                const contracts = data.contracts || [];
                
                resultsDiv.innerHTML = `
                    <div class="results-header">
                        <h3>Results for "${params.name}"</h3>
                        <span class="results-count">${data.contract_count} contracts</span>
                        ${getBackButton()}
                    </div>
                    
                    ${statsHtml}
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #1e3a5f;">Contracts Bid (${contracts.length})</h4>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Contract</th>
                                    <th>Date</th>
                                    <th>District</th>
                                    <th>County</th>
                                    <th>Result</th>
                                    <th class="number">Total Bid</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${contracts.map(c => `
                                    <tr class="${c.is_winner === 'Y' ? 'winner' : ''}">
                                        <td><a href="#" onclick="searchContractDirect('${c.contract_number}'); return false;">${c.contract_number}</a></td>
                                        <td>${c.letting_date}</td>
                                        <td>${c.district || '‚Äî'}</td>
                                        <td>${c.county || '‚Äî'}</td>
                                        <td>${c.is_winner === 'Y' ? '<span class="badge badge-winner">WON</span>' : `<span class="badge badge-rank">#${c.bidder_rank}</span>`}</td>
                                        <td class="number">${formatCurrency(c.total_bid_amount)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
                
                await checkAuth();
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function searchContract() {
            const contract = document.getElementById('contractInput').value.trim();
            if (!contract) return;
            searchContractDirect(contract);
        }
        
        async function searchContractDirect(contract) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Searching</div>';
            pushNav('contract', { contract });
            
            try {
                const response = await fetch(`/api/search/contract/${encodeURIComponent(contract)}`);
                
                if (await handleSearchError(response, resultsDiv)) {
                    await checkAuth();
                    return;
                }
                
                if (!response.ok) throw new Error('Contract not found');
                const data = await response.json();
                
                const firstBid = data.bids[0];
                const bidders = data.bidders || [];
                const winner = bidders.find(b => b.is_winner === 'Y');
                const items = data.items_comparison || [];
                
                const bidderHeaders = bidders.map(b => 
                    `<th class="${b.is_winner === 'Y' ? 'winner-col' : ''}">${b.name.substring(0, 15)}${b.name.length > 15 ? '...' : ''}<br><small>#${b.rank} - ${formatCurrency(b.total_bid)}</small></th>`
                ).join('');
                
                const comparisonRows = items.map(item => {
                    const prices = Object.values(item.bidder_prices).map(p => p.unit_price).filter(p => p > 0);
                    const lowestPrice = prices.length > 0 ? Math.min(...prices) : 0;
                    const highestPrice = prices.length > 0 ? Math.max(...prices) : 0;
                    
                    const priceCells = bidders.map(b => {
                        const priceInfo = item.bidder_prices[b.name];
                        if (!priceInfo) return `<td class="${b.is_winner === 'Y' ? 'winner-col' : ''}">‚Äî</td>`;
                        
                        let priceClass = b.is_winner === 'Y' ? 'winner-col' : '';
                        if (priceInfo.unit_price === lowestPrice && prices.length > 1) priceClass += ' low-price';
                        else if (priceInfo.unit_price === highestPrice && prices.length > 1) priceClass += ' high-price';
                        
                        return `<td class="${priceClass}">${formatCurrency(priceInfo.unit_price)}</td>`;
                    }).join('');
                    
                    return `
                        <tr>
                            <td class="item-col">
                                <a href="#" onclick="document.getElementById('payItemInput').value='${item.item_number}'; document.querySelector('[data-tab=payitem]').click(); searchPayItem(); return false;">${item.item_number}</a>
                                <br><small>${item.item_description?.substring(0, 40) || ''}</small>
                            </td>
                            <td>${item.quantity?.toLocaleString() || '‚Äî'}</td>
                            <td>${item.unit || '‚Äî'}</td>
                            ${priceCells}
                        </tr>
                    `;
                }).join('');
                
                resultsDiv.innerHTML = `
                    <div class="results-header">
                        <h3>Contract ${contract}</h3>
                        <span class="results-count">${items.length} items ‚Ä¢ ${bidders.length} bidders</span>
                        ${getBackButton()}
                    </div>
                    
                    <div class="summary-card">
                        <h4>Contract Details</h4>
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="value">${firstBid?.letting_date || '‚Äî'}</div>
                                <div class="label">Letting Date</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${firstBid?.district || '‚Äî'}</div>
                                <div class="label">District</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${firstBid?.county || '‚Äî'}</div>
                                <div class="label">County</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${winner?.name?.substring(0, 20) || '‚Äî'}</div>
                                <div class="label">Winner</div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #1e3a5f;">Bid Comparison by Item</h4>
                    <div class="table-container" style="max-height: 600px;">
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th class="item-col">Item</th>
                                    <th>Qty</th>
                                    <th>Unit</th>
                                    ${bidderHeaders}
                                </tr>
                            </thead>
                            <tbody>
                                ${comparisonRows}
                            </tbody>
                        </table>
                    </div>
                `;
                
                await checkAuth();
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        async function browseItems() {
            const search = document.getElementById('browseInput').value.trim();
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Loading</div>';
            
            try {
                let url = '/api/browse/items?limit=100';
                if (search) url += `&search=${encodeURIComponent(search)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.items.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No items found.</div>';
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <div class="results-header">
                        <h3>Pay Items${search ? ` matching "${search}"` : ''}</h3>
                        <span class="results-count">${data.items.length} items</span>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Unit</th>
                                    <th class="number">Avg Price (Winners)</th>
                                    <th class="number">Contracts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.items.map(item => `
                                    <tr>
                                        <td><a href="#" onclick="document.getElementById('payItemInput').value='${item.item_number}'; document.querySelector('[data-tab=payitem]').click(); searchPayItem(); return false;">${item.item_number}</a></td>
                                        <td>${item.item_description || '‚Äî'}</td>
                                        <td>${item.unit || '‚Äî'}</td>
                                        <td class="number">${formatCurrency(item.avg_price)}</td>
                                        <td class="number">${item.contract_count?.toLocaleString() || '‚Äî'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Estimator form
        document.getElementById('estimatorForm').addEventListener('submit', async function(e) {
            e.preventDefault();
            
            const statusDiv = document.getElementById('estimatorStatus');
            const fileInput = document.getElementById('estimatorFile');
            
            if (!fileInput.files || !fileInput.files[0]) {
                statusDiv.innerHTML = '<div class="error">Please select an Excel file.</div>';
                return;
            }
            
            const file = fileInput.files[0];
            const districtSelect = document.getElementById('estimatorDistricts');
            const selectedDistricts = Array.from(districtSelect.selectedOptions).map(opt => opt.value);
            const yearStart = document.getElementById('estimatorYearStart').value;
            const yearEnd = document.getElementById('estimatorYearEnd').value;
            
            const formData = new FormData();
            formData.append('file', file);
            formData.append('districts', selectedDistricts.join(','));
            if (yearStart) formData.append('year_start', yearStart);
            if (yearEnd) formData.append('year_end', yearEnd);
            
            statusDiv.innerHTML = '<div class="loading">Processing your file</div>';
            
            try {
                const response = await fetch('/api/estimator/price-items', {
                    method: 'POST',
                    body: formData
                });
                
                if (!response.ok) {
                    const error = await response.json();
                    throw new Error(error.detail || 'Failed to process file');
                }
                
                const itemsPriced = response.headers.get('X-Items-Priced') || '?';
                const itemsNotFound = response.headers.get('X-Items-Not-Found') || '?';
                const totalValue = response.headers.get('X-Total-Value') || '0';
                
                const blob = await response.blob();
                const url = window.URL.createObjectURL(blob);
                const a = document.createElement('a');
                a.href = url;
                a.download = `priced_${file.name}`;
                document.body.appendChild(a);
                a.click();
                document.body.removeChild(a);
                
                statusDiv.innerHTML = `
                    <div class="summary-card" style="border-left-color: #28a745;">
                        <h4 style="color: #28a745;">‚úÖ Pricing Complete!</h4>
                        <div class="summary-stats" style="margin-top: 0.75rem;">
                            <div class="summary-stat">
                                <div class="value">${itemsPriced}</div>
                                <div class="label">Items Priced</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${itemsNotFound}</div>
                                <div class="label">Not Found</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${formatCurrency(parseFloat(totalValue))}</div>
                                <div class="label">Total Value</div>
                            </div>
                        </div>
                    </div>
                `;
            } catch (error) {
                statusDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        });

        // Enter key support
        document.getElementById('payItemInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchPayItem(); });
        document.getElementById('contractorInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchContractor(); });
        document.getElementById('contractInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchContract(); });
        document.getElementById('browseInput').addEventListener('keypress', e => { if (e.key === 'Enter') browseItems(); });

        // Initialize
        checkUrlParams();
        checkAuth();
        loadStats();
        loadDistricts();
    </script>
</body>
</html>
