<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>IDOT Bid Intelligence Platform</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: -apple-system, BlinkMacSystemFont, 'Segoe UI', Roboto, Oxygen, Ubuntu, Cantarell, sans-serif;
            background: #f5f7fa;
            color: #2c3e50;
            line-height: 1.6;
        }

        .header {
            background: linear-gradient(135deg, #1e3a5f 0%, #2d5a87 100%);
            color: white;
            padding: 2rem 1rem;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }

        .header-content {
            display: flex;
            justify-content: space-between;
            align-items: center;
            flex-wrap: wrap;
            gap: 1rem;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 1rem;
        }

        .header h1 {
            font-size: 2rem;
            margin-bottom: 0.5rem;
        }

        .header p {
            opacity: 0.9;
            font-size: 1.1rem;
        }

        .header-buttons {
            display: flex;
            gap: 0.5rem;
        }

        .header-btn {
            padding: 0.5rem 1rem;
            background: rgba(255,255,255,0.2);
            color: white;
            border: 1px solid rgba(255,255,255,0.3);
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.9rem;
            text-decoration: none;
            transition: background 0.2s;
        }

        .header-btn:hover {
            background: rgba(255,255,255,0.3);
        }

        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(180px, 1fr));
            gap: 1rem;
            margin: 2rem 0;
        }

        .stat-card {
            background: white;
            padding: 1.25rem;
            border-radius: 8px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            text-align: center;
        }

        .stat-card .value {
            font-size: 1.8rem;
            font-weight: bold;
            color: #1e3a5f;
        }

        .stat-card .label {
            color: #7f8c8d;
            font-size: 0.85rem;
            margin-top: 0.25rem;
        }

        .search-section {
            background: white;
            padding: 1.5rem;
            border-radius: 8px;
            margin: 2rem 0;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
        }

        .tab-buttons {
            display: flex;
            gap: 0.5rem;
            margin-bottom: 1.5rem;
            flex-wrap: wrap;
        }

        .tab-button {
            padding: 0.6rem 1.2rem;
            background: #f8f9fa;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.95rem;
            transition: all 0.2s;
        }

        .tab-button:hover {
            border-color: #1e3a5f;
        }

        .tab-button.active {
            background: #1e3a5f;
            color: white;
            border-color: #1e3a5f;
        }

        .search-box {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
        }

        .search-box input, .search-box select {
            padding: 0.7rem;
            border: 2px solid #e0e0e0;
            border-radius: 4px;
            font-size: 1rem;
        }

        .search-box input {
            flex: 1;
            min-width: 200px;
        }

        .search-box input:focus, .search-box select:focus {
            outline: none;
            border-color: #1e3a5f;
        }

        .search-box button {
            padding: 0.7rem 1.5rem;
            background: #1e3a5f;
            color: white;
            border: none;
            border-radius: 4px;
            font-size: 1rem;
            cursor: pointer;
            transition: background 0.2s;
        }

        .search-box button:hover {
            background: #2d5a87;
        }

        .filters {
            display: flex;
            gap: 0.75rem;
            margin-bottom: 1rem;
            flex-wrap: wrap;
            align-items: center;
        }

        .filters label {
            font-size: 0.9rem;
            color: #666;
        }

        .filters input, .filters select {
            padding: 0.5rem;
            border: 1px solid #ddd;
            border-radius: 4px;
            font-size: 0.9rem;
        }

        .results {
            margin-top: 1.5rem;
        }

        .results-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 1rem;
            padding-bottom: 0.5rem;
            border-bottom: 2px solid #e0e0e0;
            flex-wrap: wrap;
            gap: 0.5rem;
        }

        .results-header h3 {
            color: #1e3a5f;
        }

        .results-count {
            color: #666;
            font-size: 0.9rem;
        }

        .back-button {
            padding: 0.4rem 0.8rem;
            background: #6c757d;
            color: white;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 0.85rem;
            transition: background 0.2s;
        }

        .back-button:hover {
            background: #5a6268;
        }

        .summary-card {
            background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
            padding: 1.25rem;
            border-radius: 8px;
            margin-bottom: 1.5rem;
            border-left: 4px solid #1e3a5f;
        }

        .summary-card h4 {
            color: #1e3a5f;
            margin-bottom: 0.75rem;
        }

        .summary-stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(150px, 1fr));
            gap: 1rem;
        }

        .summary-stat {
            text-align: center;
        }

        .summary-stat .value {
            font-size: 1.4rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .summary-stat .label {
            font-size: 0.8rem;
            color: #666;
        }

        .yearly-trends {
            margin: 1rem 0;
        }

        .trend-bar {
            display: flex;
            align-items: center;
            margin: 0.4rem 0;
            font-size: 0.9rem;
        }

        .trend-bar .year {
            width: 50px;
            font-weight: 600;
            color: #1e3a5f;
        }

        .trend-bar .bar-container {
            flex: 1;
            height: 24px;
            background: #e9ecef;
            border-radius: 4px;
            margin: 0 0.75rem;
            position: relative;
            overflow: hidden;
        }

        .trend-bar .bar {
            height: 100%;
            background: linear-gradient(90deg, #1e3a5f 0%, #2d5a87 100%);
            border-radius: 4px;
            display: flex;
            align-items: center;
            justify-content: flex-end;
            padding-right: 8px;
            color: white;
            font-size: 0.75rem;
            font-weight: 600;
            min-width: 50px;
        }

        .trend-bar .count {
            width: 100px;
            text-align: right;
            color: #666;
            font-size: 0.85rem;
        }

        .data-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.9rem;
            margin-top: 1rem;
        }

        .data-table th {
            background: #1e3a5f;
            color: white;
            padding: 0.75rem 0.5rem;
            text-align: left;
            font-weight: 600;
            position: sticky;
            top: 0;
        }

        .data-table td {
            padding: 0.6rem 0.5rem;
            border-bottom: 1px solid #e0e0e0;
        }

        .data-table tr:hover {
            background: #f8f9fa;
        }

        .data-table .number {
            text-align: right;
            font-family: 'SF Mono', Monaco, monospace;
        }

        .data-table .winner {
            background: #d4edda;
        }

        .data-table .winner:hover {
            background: #c3e6cb;
        }

        .badge {
            display: inline-block;
            padding: 0.2rem 0.5rem;
            border-radius: 4px;
            font-size: 0.75rem;
            font-weight: 600;
        }

        .badge-winner {
            background: #28a745;
            color: white;
        }

        .badge-rank {
            background: #6c757d;
            color: white;
        }

        .table-container {
            max-height: 500px;
            overflow-y: auto;
            border: 1px solid #e0e0e0;
            border-radius: 4px;
        }

        .comparison-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 0.85rem;
        }

        .comparison-table th {
            background: #1e3a5f;
            color: white;
            padding: 0.5rem;
            text-align: center;
            font-weight: 600;
            position: sticky;
            top: 0;
            white-space: nowrap;
        }

        .comparison-table th.item-col {
            text-align: left;
            min-width: 200px;
        }

        .comparison-table td {
            padding: 0.4rem 0.5rem;
            border-bottom: 1px solid #e0e0e0;
            text-align: center;
        }

        .comparison-table td.item-col {
            text-align: left;
            background: #f8f9fa;
        }

        .comparison-table .winner-col {
            background: #d4edda;
        }

        .comparison-table .low-price {
            color: #28a745;
            font-weight: bold;
        }

        .comparison-table .high-price {
            color: #dc3545;
        }

        .loading {
            text-align: center;
            padding: 2rem;
            color: #7f8c8d;
        }

        .loading::after {
            content: '';
            animation: dots 1.5s infinite;
        }

        @keyframes dots {
            0%, 20% { content: '.'; }
            40% { content: '..'; }
            60%, 100% { content: '...'; }
        }

        .error {
            background: #f8d7da;
            color: #721c24;
            padding: 1rem;
            border-radius: 4px;
            margin: 1rem 0;
        }

        .no-results {
            text-align: center;
            padding: 2rem;
            color: #666;
            background: #f8f9fa;
            border-radius: 4px;
        }

        .contractor-card {
            background: white;
            border: 1px solid #e0e0e0;
            border-radius: 8px;
            padding: 1rem;
            margin-bottom: 1rem;
        }

        .contractor-card h4 {
            color: #1e3a5f;
            margin-bottom: 0.5rem;
        }

        .contractor-stats {
            display: flex;
            gap: 2rem;
            flex-wrap: wrap;
        }

        .contractor-stat {
            text-align: center;
        }

        .contractor-stat .value {
            font-size: 1.5rem;
            font-weight: bold;
            color: #2c3e50;
        }

        .contractor-stat .label {
            font-size: 0.8rem;
            color: #666;
        }

        .footer {
            text-align: center;
            padding: 2rem 1rem;
            color: #7f8c8d;
            margin-top: 2rem;
        }

        .hidden {
            display: none !important;
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0,0,0,0.5);
        }

        .modal.show {
            display: flex;
            align-items: center;
            justify-content: center;
        }

        .modal-content {
            background: white;
            padding: 2rem;
            border-radius: 8px;
            max-width: 700px;
            max-height: 80vh;
            overflow-y: auto;
            margin: 1rem;
        }

        .modal-content h2 {
            color: #1e3a5f;
            margin-bottom: 1rem;
        }

        .modal-content h3 {
            color: #2d5a87;
            margin-top: 1.5rem;
            margin-bottom: 0.5rem;
        }

        .modal-content p {
            margin-bottom: 1rem;
        }

        .modal-content ul {
            margin-left: 1.5rem;
            margin-bottom: 1rem;
        }

        .modal-content li {
            margin-bottom: 0.5rem;
        }

        .close-modal {
            float: right;
            font-size: 1.5rem;
            font-weight: bold;
            cursor: pointer;
            color: #666;
        }

        .close-modal:hover {
            color: #333;
        }

        .disclaimer {
            background: #fff3cd;
            border: 1px solid #ffc107;
            padding: 1rem;
            border-radius: 4px;
            margin-top: 1rem;
        }

        @media (max-width: 768px) {
            .header h1 {
                font-size: 1.5rem;
            }
            
            .stats-grid {
                grid-template-columns: repeat(2, 1fr);
            }
            
            .data-table {
                font-size: 0.8rem;
            }
            
            .data-table th, .data-table td {
                padding: 0.5rem 0.3rem;
            }

            .header-content {
                flex-direction: column;
                align-items: flex-start;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <div class="container">
            <div class="header-content">
                <div>
                    <h1>üèóÔ∏è IDOT Bid Intelligence Platform</h1>
                    <p>Construction bid pricing data for Illinois ‚Ä¢ 2018-2025</p>
                </div>
                <div class="header-buttons">
                    <button class="header-btn" onclick="showHelp()">‚ùì Help</button>
                </div>
            </div>
        </div>
    </div>

    <div class="container">
        <!-- Stats Dashboard -->
        <div class="stats-grid" id="stats">
            <div class="stat-card">
                <div class="value">‚Äî</div>
                <div class="label">Loading...</div>
            </div>
        </div>

        <!-- Search Section -->
        <div class="search-section">
            <div class="tab-buttons">
                <button class="tab-button active" data-tab="payitem">Pay Item Search</button>
                <button class="tab-button" data-tab="contractor">Contractor Search</button>
                <button class="tab-button" data-tab="contract">Contract Lookup</button>
                <button class="tab-button" data-tab="browse">Browse Items</button>
            </div>

            <!-- Pay Item Search -->
            <div id="payitem-tab" class="tab-content">
                <div class="search-box">
                    <input type="text" id="payItemInput" placeholder="Enter item code (e.g., 40603080, 60105)" />
                    <button onclick="searchPayItem()">Search</button>
                </div>
                <div class="filters">
                    <label>District:</label>
                    <select id="payItemDistrict">
                        <option value="">All</option>
                    </select>
                    <label>County:</label>
                    <input type="text" id="payItemCounty" placeholder="Optional" style="width: 120px;" />
                    <label>Year From:</label>
                    <select id="payItemYearStart">
                        <option value="">All</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                    </select>
                    <label>To:</label>
                    <select id="payItemYearEnd">
                        <option value="">All</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                    </select>
                </div>
            </div>

            <!-- Contractor Search -->
            <div id="contractor-tab" class="tab-content hidden">
                <div class="search-box">
                    <input type="text" id="contractorInput" placeholder="Enter contractor name (e.g., K-Five, Gallagher, Alliance)" />
                    <button onclick="searchContractor()">Search</button>
                </div>
                <div class="filters">
                    <label>District:</label>
                    <select id="contractorDistrict">
                        <option value="">All</option>
                    </select>
                    <label>County:</label>
                    <input type="text" id="contractorCounty" placeholder="Optional" style="width: 120px;" />
                    <label>Year From:</label>
                    <select id="contractorYearStart">
                        <option value="">All</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                    </select>
                    <label>To:</label>
                    <select id="contractorYearEnd">
                        <option value="">All</option>
                        <option value="2025">2025</option>
                        <option value="2024">2024</option>
                        <option value="2023">2023</option>
                        <option value="2022">2022</option>
                        <option value="2021">2021</option>
                        <option value="2020">2020</option>
                        <option value="2019">2019</option>
                        <option value="2018">2018</option>
                    </select>
                </div>
            </div>

            <!-- Contract Lookup -->
            <div id="contract-tab" class="tab-content hidden">
                <div class="search-box">
                    <input type="text" id="contractInput" placeholder="Enter contract number (e.g., 61J77, 62T57)" />
                    <button onclick="searchContract()">Search</button>
                </div>
            </div>

            <!-- Browse Items -->
            <div id="browse-tab" class="tab-content hidden">
                <div class="search-box">
                    <input type="text" id="browseInput" placeholder="Search by item code or description" />
                    <button onclick="browseItems()">Search</button>
                </div>
            </div>

            <div id="results" class="results"></div>
        </div>
    </div>

    <div class="footer">
        <p>IDOT Bid Intelligence Platform v2.0 ‚Ä¢ Data may be incomplete or contain errors</p>
    </div>

    <!-- Help Modal -->
    <div id="helpModal" class="modal">
        <div class="modal-content">
            <span class="close-modal" onclick="closeHelp()">&times;</span>
            <h2>üìñ How to Use This Platform</h2>
            
            <h3>Pay Item Search</h3>
            <p>Search for specific bid items by their IDOT item code (e.g., 40603080 for HMA Surface Removal). View pricing history across all contractors and projects.</p>
            <ul>
                <li>Prices shown are <strong>weighted averages</strong> based on quantity</li>
                <li>Filter by district, county, or year range</li>
                <li>Click on any contract number to see full details</li>
            </ul>

            <h3>Contractor Search</h3>
            <p>Look up any contractor's bidding history, win rate, and contract performance.</p>
            <ul>
                <li>See all contracts a contractor has bid on</li>
                <li>Green highlighted rows indicate won contracts</li>
                <li>Filter by district, county, or date range</li>
            </ul>

            <h3>Contract Lookup</h3>
            <p>View complete bid tabulation for any contract, showing all bidders and their prices side-by-side.</p>
            <ul>
                <li>Compare item-by-item pricing across all bidders</li>
                <li>Winner's column is highlighted in green</li>
                <li>Click any item number to search for pricing history</li>
            </ul>

            <h3>Browse Items</h3>
            <p>Explore all pay items in the database with their average prices and usage frequency.</p>

            <div class="disclaimer">
                <strong>‚ö†Ô∏è Disclaimer:</strong> This data is compiled from IDOT bid tabulations and may be incomplete, contain parsing errors, or be missing recent lettings. Always verify critical pricing information against official IDOT sources. This tool is for estimation purposes only and should not be the sole basis for bid decisions.
            </div>
        </div>
    </div>

    <script>
        // Navigation history
        let navHistory = [];

        // Tab switching
        document.querySelectorAll('.tab-button').forEach(btn => {
            btn.addEventListener('click', () => {
                document.querySelectorAll('.tab-button').forEach(b => b.classList.remove('active'));
                document.querySelectorAll('.tab-content').forEach(t => t.classList.add('hidden'));
                btn.classList.add('active');
                document.getElementById(btn.dataset.tab + '-tab').classList.remove('hidden');
                document.getElementById('results').innerHTML = '';
                navHistory = [];
            });
        });

        // Load statistics
        async function loadStats() {
            try {
                const response = await fetch('/api/analytics/summary');
                if (!response.ok) throw new Error('Failed to load stats');
                const data = await response.json();
                
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="value">${(data.total_bid_rows / 1000000).toFixed(2)}M</div>
                        <div class="label">Bid Records</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.unique_contracts?.toLocaleString() || '‚Äî'}</div>
                        <div class="label">Contracts</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.unique_contractors?.toLocaleString() || '‚Äî'}</div>
                        <div class="label">Contractors</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.unique_items?.toLocaleString() || '‚Äî'}</div>
                        <div class="label">Pay Items</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.unique_counties || '‚Äî'}</div>
                        <div class="label">Counties</div>
                    </div>
                    <div class="stat-card">
                        <div class="value">${data.year_range?.min || '‚Äî'}-${data.year_range?.max || '‚Äî'}</div>
                        <div class="label">Year Range</div>
                    </div>
                `;
            } catch (error) {
                console.error('Error loading stats:', error);
                document.getElementById('stats').innerHTML = `
                    <div class="stat-card">
                        <div class="value">‚Äî</div>
                        <div class="label">Error loading stats</div>
                    </div>
                `;
            }
        }

        // Load districts for filters
        async function loadDistricts() {
            try {
                const response = await fetch('/api/browse/districts');
                const data = await response.json();
                
                const districtOptions = '<option value="">All</option>' + 
                    data.districts.map(d => `<option value="${d.district}">${d.district} (${d.contract_count})</option>`).join('');
                
                document.getElementById('payItemDistrict').innerHTML = districtOptions;
                document.getElementById('contractorDistrict').innerHTML = districtOptions;
            } catch (error) {
                console.error('Error loading districts:', error);
            }
        }

        // Format currency
        function formatCurrency(value) {
            if (value === null || value === undefined || value === '') return '‚Äî';
            return '$' + parseFloat(value).toLocaleString('en-US', { minimumFractionDigits: 2, maximumFractionDigits: 2 });
        }

        // Navigation functions
        function pushNav(type, params) {
            navHistory.push({ type, params });
        }

        function goBack() {
            if (navHistory.length > 1) {
                navHistory.pop(); // Remove current
                const prev = navHistory.pop(); // Get previous
                if (prev.type === 'contractor') {
                    searchContractorWithParams(prev.params);
                } else if (prev.type === 'contract') {
                    searchContractDirect(prev.params.contract);
                } else if (prev.type === 'payitem') {
                    searchPayItemWithParams(prev.params);
                }
            }
        }

        function getBackButton() {
            if (navHistory.length > 1) {
                return '<button class="back-button" onclick="goBack()">‚Üê Back</button>';
            }
            return '';
        }

        // Help Modal
        function showHelp() {
            document.getElementById('helpModal').classList.add('show');
        }

        function closeHelp() {
            document.getElementById('helpModal').classList.remove('show');
        }

        // Close modal on outside click
        document.getElementById('helpModal').addEventListener('click', function(e) {
            if (e.target === this) closeHelp();
        });

        // Pay Item Search
        async function searchPayItem() {
            const params = {
                itemCode: document.getElementById('payItemInput').value.trim(),
                county: document.getElementById('payItemCounty').value.trim(),
                district: document.getElementById('payItemDistrict').value,
                yearStart: document.getElementById('payItemYearStart').value,
                yearEnd: document.getElementById('payItemYearEnd').value
            };
            searchPayItemWithParams(params);
        }

        async function searchPayItemWithParams(params) {
            if (!params.itemCode) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Searching</div>';
            
            pushNav('payitem', params);
            
            try {
                let url = `/api/search/pay-item/${encodeURIComponent(params.itemCode)}?limit=1000`;
                if (params.county) url += `&county=${encodeURIComponent(params.county)}`;
                if (params.district) url += `&district=${encodeURIComponent(params.district)}`;
                if (params.yearStart) url += `&year_start=${params.yearStart}`;
                if (params.yearEnd) url += `&year_end=${params.yearEnd}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.result_count === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No results found for this item code.</div>';
                    return;
                }
                
                // Calculate summary stats using WEIGHTED averages
                const validBids = data.bids.filter(b => b.unit_price > 0 && b.quantity > 0);
                const totalExtension = validBids.reduce((sum, b) => sum + (b.extension || 0), 0);
                const totalQuantity = validBids.reduce((sum, b) => sum + (b.quantity || 0), 0);
                const weightedAvgPrice = totalQuantity > 0 ? totalExtension / totalQuantity : 0;
                
                const prices = validBids.map(b => b.unit_price);
                const minPrice = prices.length > 0 ? Math.min(...prices) : 0;
                const maxPrice = prices.length > 0 ? Math.max(...prices) : 0;
                
                // Get unique descriptions
                const descriptions = [...new Set(data.bids.map(b => b.item_description))];
                const units = [...new Set(data.bids.map(b => b.unit))];
                
                // Build yearly trends chart with WEIGHTED averages
                let trendsHtml = '';
                if (data.yearly_trends && data.yearly_trends.length > 0) {
                    const maxCount = Math.max(...data.yearly_trends.map(t => t.bid_count));
                    trendsHtml = `
                        <div class="yearly-trends">
                            <h4 style="margin-bottom: 0.75rem; color: #1e3a5f;">Yearly Pricing Trends (Weighted Average)</h4>
                            ${data.yearly_trends.map(t => `
                                <div class="trend-bar">
                                    <span class="year">${t.year}</span>
                                    <div class="bar-container">
                                        <div class="bar" style="width: ${(t.bid_count / maxCount * 100)}%">
                                            ${formatCurrency(t.weighted_avg_price)}
                                        </div>
                                    </div>
                                    <span class="count">${t.bid_count} bids ‚Ä¢ ${Number(t.total_quantity || 0).toLocaleString()} ${units[0] || 'units'}</span>
                                </div>
                            `).join('')}
                        </div>
                    `;
                }
                
                resultsDiv.innerHTML = `
                    <div class="results-header">
                        <h3>Results for "${params.itemCode}"</h3>
                        <span class="results-count">${data.result_count.toLocaleString()} bid records</span>
                        ${getBackButton()}
                    </div>
                    
                    <div class="summary-card">
                        <h4>${descriptions[0] || params.itemCode}</h4>
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="value">${formatCurrency(weightedAvgPrice)}</div>
                                <div class="label">Weighted Avg Price</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${formatCurrency(minPrice)}</div>
                                <div class="label">Min Price</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${formatCurrency(maxPrice)}</div>
                                <div class="label">Max Price</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${units[0] || '‚Äî'}</div>
                                <div class="label">Unit</div>
                            </div>
                        </div>
                    </div>
                    
                    ${trendsHtml}
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Contract</th>
                                    <th>Date</th>
                                    <th>County</th>
                                    <th>Bidder</th>
                                    <th>Rank</th>
                                    <th class="number">Qty</th>
                                    <th class="number">Unit Price</th>
                                    <th class="number">Extension</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.bids.slice(0, 200).map(bid => `
                                    <tr class="${bid.is_winner === 'Y' ? 'winner' : ''}">
                                        <td><a href="#" onclick="searchContractDirect('${bid.contract_number}'); return false;">${bid.contract_number}</a></td>
                                        <td>${bid.letting_date}</td>
                                        <td>${bid.county || '‚Äî'}</td>
                                        <td>${bid.bidder_name}${bid.is_winner === 'Y' ? ' <span class="badge badge-winner">WIN</span>' : ''}</td>
                                        <td><span class="badge badge-rank">#${bid.bidder_rank}</span></td>
                                        <td class="number">${bid.quantity?.toLocaleString() || '‚Äî'}</td>
                                        <td class="number">${formatCurrency(bid.unit_price)}</td>
                                        <td class="number">${formatCurrency(bid.extension)}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                    ${data.bids.length > 200 ? `<p style="margin-top: 0.5rem; color: #666; font-size: 0.85rem;">Showing first 200 of ${data.bids.length} records</p>` : ''}
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Contractor Search
        async function searchContractor() {
            const params = {
                name: document.getElementById('contractorInput').value.trim(),
                county: document.getElementById('contractorCounty').value.trim(),
                district: document.getElementById('contractorDistrict').value,
                yearStart: document.getElementById('contractorYearStart').value,
                yearEnd: document.getElementById('contractorYearEnd').value
            };
            searchContractorWithParams(params);
        }

        async function searchContractorWithParams(params) {
            if (!params.name) return;
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Searching</div>';
            
            pushNav('contractor', params);
            
            try {
                let url = `/api/search/contractor/${encodeURIComponent(params.name)}`;
                const queryParams = [];
                if (params.county) queryParams.push(`county=${encodeURIComponent(params.county)}`);
                if (params.district) queryParams.push(`district=${encodeURIComponent(params.district)}`);
                if (params.yearStart) queryParams.push(`year_start=${params.yearStart}`);
                if (params.yearEnd) queryParams.push(`year_end=${params.yearEnd}`);
                if (queryParams.length > 0) url += '?' + queryParams.join('&');
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.contract_count === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No results found for this contractor.</div>';
                    return;
                }
                
                // Build contractor stats cards
                let statsHtml = '';
                if (data.contractor_stats && data.contractor_stats.length > 0) {
                    statsHtml = data.contractor_stats.map(stat => `
                        <div class="contractor-card">
                            <h4>${stat.bidder_name}</h4>
                            <div class="contractor-stats">
                                <div class="contractor-stat">
                                    <div class="value">${stat.contracts_bid}</div>
                                    <div class="label">Contracts Bid</div>
                                </div>
                                <div class="contractor-stat">
                                    <div class="value">${stat.contracts_won || 0}</div>
                                    <div class="label">Contracts Won</div>
                                </div>
                                <div class="contractor-stat">
                                    <div class="value">${stat.win_rate.toFixed(1)}%</div>
                                    <div class="label">Win Rate</div>
                                </div>
                                <div class="contractor-stat">
                                    <div class="value">${stat.avg_rank?.toFixed(1) || '‚Äî'}</div>
                                    <div class="label">Avg Rank</div>
                                </div>
                                <div class="contractor-stat">
                                    <div class="value">${formatCurrency(stat.total_won_value)}</div>
                                    <div class="label">Total Won Value</div>
                                </div>
                            </div>
                        </div>
                    `).join('');
                }
                
                // Use contracts array from API (already one row per contract)
                const contracts = data.contracts || [];
                
                resultsDiv.innerHTML = `
                    <div class="results-header">
                        <h3>Results for "${params.name}"</h3>
                        <span class="results-count">${data.contract_count} contracts</span>
                        ${getBackButton()}
                    </div>
                    
                    ${statsHtml}
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #1e3a5f;">Contracts Bid (${contracts.length})</h4>
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Contract</th>
                                    <th>Date</th>
                                    <th>District</th>
                                    <th>County</th>
                                    <th>Result</th>
                                    <th class="number">Total Bid</th>
                                    <th>Items</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${contracts.map(c => `
                                    <tr class="${c.is_winner === 'Y' ? 'winner' : ''}">
                                        <td><a href="#" onclick="searchContractDirect('${c.contract_number}'); return false;">${c.contract_number}</a></td>
                                        <td>${c.letting_date}</td>
                                        <td>${c.district || '‚Äî'}</td>
                                        <td>${c.county || '‚Äî'}</td>
                                        <td>${c.is_winner === 'Y' ? '<span class="badge badge-winner">WON</span>' : `<span class="badge badge-rank">#${c.bidder_rank}</span>`}</td>
                                        <td class="number">${formatCurrency(c.total_bid_amount)}</td>
                                        <td>${c.item_count} items</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Contract Search
        async function searchContract() {
            const contract = document.getElementById('contractInput').value.trim();
            if (!contract) return;
            searchContractDirect(contract);
        }
        
        async function searchContractDirect(contract) {
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Searching</div>';
            
            pushNav('contract', { contract });
            
            try {
                const response = await fetch(`/api/search/contract/${encodeURIComponent(contract)}`);
                if (!response.ok) throw new Error('Contract not found');
                const data = await response.json();
                
                // Get contract info from first bid
                const firstBid = data.bids[0];
                const bidders = data.bidders || [];
                const winner = bidders.find(b => b.is_winner === 'Y');
                const items = data.items_comparison || [];
                
                // Build comparison table header
                const bidderHeaders = bidders.map(b => 
                    `<th class="${b.is_winner === 'Y' ? 'winner-col' : ''}">${b.name.substring(0, 15)}${b.name.length > 15 ? '...' : ''}<br><small>#${b.rank} - ${formatCurrency(b.total_bid)}</small></th>`
                ).join('');
                
                // Build comparison table rows
                const comparisonRows = items.map(item => {
                    // Find lowest price for this item
                    const prices = Object.values(item.bidder_prices).map(p => p.unit_price).filter(p => p > 0);
                    const lowestPrice = prices.length > 0 ? Math.min(...prices) : 0;
                    const highestPrice = prices.length > 0 ? Math.max(...prices) : 0;
                    
                    const priceCells = bidders.map(b => {
                        const priceInfo = item.bidder_prices[b.name];
                        if (!priceInfo) return `<td class="${b.is_winner === 'Y' ? 'winner-col' : ''}">‚Äî</td>`;
                        
                        let priceClass = b.is_winner === 'Y' ? 'winner-col' : '';
                        if (priceInfo.unit_price === lowestPrice && prices.length > 1) priceClass += ' low-price';
                        else if (priceInfo.unit_price === highestPrice && prices.length > 1) priceClass += ' high-price';
                        
                        return `<td class="${priceClass}">${formatCurrency(priceInfo.unit_price)}</td>`;
                    }).join('');
                    
                    return `
                        <tr>
                            <td class="item-col">
                                <a href="#" onclick="document.getElementById('payItemInput').value='${item.item_number}'; document.querySelector('[data-tab=payitem]').click(); searchPayItem(); return false;">${item.item_number}</a>
                                <br><small>${item.item_description?.substring(0, 40) || ''}${item.item_description?.length > 40 ? '...' : ''}</small>
                            </td>
                            <td>${item.quantity?.toLocaleString() || '‚Äî'}</td>
                            <td>${item.unit || '‚Äî'}</td>
                            ${priceCells}
                        </tr>
                    `;
                }).join('');
                
                resultsDiv.innerHTML = `
                    <div class="results-header">
                        <h3>Contract ${contract}</h3>
                        <span class="results-count">${items.length} items ‚Ä¢ ${bidders.length} bidders</span>
                        ${getBackButton()}
                    </div>
                    
                    <div class="summary-card">
                        <h4>Contract Details</h4>
                        <div class="summary-stats">
                            <div class="summary-stat">
                                <div class="value">${firstBid?.letting_date || '‚Äî'}</div>
                                <div class="label">Letting Date</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${firstBid?.district || '‚Äî'}</div>
                                <div class="label">District</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${firstBid?.county || '‚Äî'}</div>
                                <div class="label">County</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${bidders.length}</div>
                                <div class="label">Bidders</div>
                            </div>
                            <div class="summary-stat">
                                <div class="value">${winner?.name?.substring(0, 20) || '‚Äî'}${winner?.name?.length > 20 ? '...' : ''}</div>
                                <div class="label">Winner</div>
                            </div>
                        </div>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #1e3a5f;">Bid Comparison by Item</h4>
                    <p style="font-size: 0.85rem; color: #666; margin-bottom: 0.5rem;">
                        <span class="low-price">Green = lowest price</span> ‚Ä¢ 
                        <span class="high-price">Red = highest price</span> ‚Ä¢ 
                        Winner column highlighted
                    </p>
                    <div class="table-container" style="max-height: 600px;">
                        <table class="comparison-table">
                            <thead>
                                <tr>
                                    <th class="item-col">Item</th>
                                    <th>Qty</th>
                                    <th>Unit</th>
                                    ${bidderHeaders}
                                </tr>
                            </thead>
                            <tbody>
                                ${comparisonRows}
                            </tbody>
                        </table>
                    </div>
                    
                    <h4 style="margin: 1.5rem 0 1rem; color: #1e3a5f;">Bidder Totals</h4>
                    ${bidders.map(b => `
                        <div class="contractor-card" style="${b.is_winner === 'Y' ? 'border-left: 4px solid #28a745;' : ''}">
                            <h4>${b.is_winner === 'Y' ? 'üèÜ ' : ''}${b.name} ${b.is_winner === 'Y' ? '<span class="badge badge-winner">WINNER</span>' : `<span class="badge badge-rank">Rank #${b.rank}</span>`}</h4>
                            <p style="margin: 0.5rem 0; font-size: 1.1rem;"><strong>Total Bid: ${formatCurrency(b.total_bid)}</strong></p>
                        </div>
                    `).join('')}
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Browse Items
        async function browseItems() {
            const search = document.getElementById('browseInput').value.trim();
            
            const resultsDiv = document.getElementById('results');
            resultsDiv.innerHTML = '<div class="loading">Loading</div>';
            
            try {
                let url = '/api/browse/items?limit=100';
                if (search) url += `&search=${encodeURIComponent(search)}`;
                
                const response = await fetch(url);
                const data = await response.json();
                
                if (data.items.length === 0) {
                    resultsDiv.innerHTML = '<div class="no-results">No items found.</div>';
                    return;
                }
                
                resultsDiv.innerHTML = `
                    <div class="results-header">
                        <h3>Pay Items${search ? ` matching "${search}"` : ''}</h3>
                        <span class="results-count">${data.items.length} items</span>
                    </div>
                    
                    <div class="table-container">
                        <table class="data-table">
                            <thead>
                                <tr>
                                    <th>Item Code</th>
                                    <th>Description</th>
                                    <th>Unit</th>
                                    <th class="number">Weighted Avg Price</th>
                                    <th class="number">Bid Count</th>
                                    <th class="number">Contracts</th>
                                </tr>
                            </thead>
                            <tbody>
                                ${data.items.map(item => `
                                    <tr>
                                        <td><a href="#" onclick="document.getElementById('payItemInput').value='${item.item_number}'; document.querySelector('[data-tab=payitem]').click(); searchPayItem(); return false;">${item.item_number}</a></td>
                                        <td>${item.item_description || '‚Äî'}</td>
                                        <td>${item.unit || '‚Äî'}</td>
                                        <td class="number">${formatCurrency(item.avg_price)}</td>
                                        <td class="number">${item.bid_count?.toLocaleString() || '‚Äî'}</td>
                                        <td class="number">${item.contract_count?.toLocaleString() || '‚Äî'}</td>
                                    </tr>
                                `).join('')}
                            </tbody>
                        </table>
                    </div>
                `;
            } catch (error) {
                resultsDiv.innerHTML = `<div class="error">Error: ${error.message}</div>`;
            }
        }

        // Enter key support
        document.getElementById('payItemInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchPayItem(); });
        document.getElementById('contractorInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchContractor(); });
        document.getElementById('contractInput').addEventListener('keypress', e => { if (e.key === 'Enter') searchContract(); });
        document.getElementById('browseInput').addEventListener('keypress', e => { if (e.key === 'Enter') browseItems(); });

        // Load stats and districts on page load
        loadStats();
        loadDistricts();
    </script>
</body>
</html>
